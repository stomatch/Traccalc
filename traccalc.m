%% ������� ������ �������� ������ �� ������������� ����
% ������ ������������ ��� ���� ��������� ��������:
%
% # ����� ������������ �����
% # ����� ������������ ���� (������������ �������� �������� �.�. ����������
%%

format long;
tic
%% ���������� ���������� � ��������� ������� �������
global ksi
global traction %������� �������������� ����������
global mp       %����� ������� ������� 
global ml       %����� ����������

ksi = 8.125*10^-3;
%%
% ������������� ����������
profile=0;      %������� ����
vn=0;           %��������� �������� ��������
sn=0;           %��������� ���������� ��������
tn=0;           %��������� ������ �������
sk=10;           %�������� ����� ���� (��)
limitation=0;   %����������� �������� �� ������� ����
traction=0;     %������� ��������������
breaking_pn=0;  %��������� �������������� (�������������� ����������)
breaking_el=0;  %��������� �������������� (������������� ����������)
ml=0;           %����� ����������
mp=0;           %����� ������� �������
res=0;          %�������� �������� ������������� �������� ������
wag_count=0;    %����� ������� � �������
v=vn;           %������� �������� ������������� ������ ��������� ��������           
s=sn;           %������� ���������� ������ ������������ � ��������� ����������
t=tn;           %������� ����� �������� ������������ � ���������� ������� ��������
sr=0;
%% �������� ������ ��� �������
% ��������� ������� ����
profile=dlmread('InputData/prof.csv',';');              %��������� ������� ����
%%
% ��������� ������� �������������� � ����� ���������� (����� ���������� ��������� � ����� � �������� ���������������� (� ������)
traction=dlmread('InputData\tx-vl10.csv',';');          %��������� ������� ��������������
ml=traction(1,1);   %����� ���������� ��������� � ����� � �������� ���������������� (� ������)
%%
% ������������� ����� ������� �������
mp=6000;            %����� ������� ������� (� ������)
%%
% ��������� �������������� ��������������� � �������������� ����������
breaking_pn=dlmread('InputData\pnbreak.csv',';');       %��������� �������������� ��������������� ����������
breaking_el=dlmread('InputData\rek_breaking.csv',';');  %��������� �������������� �������������� ����������
%%
% ��������� ������������ ��������� ������������� �������� ������
res=dlmread('InputData\res.csv',';');   %�������������� (�� �� ���) �������� �������� ������������� �������� ������
%%
% ��������� ����������� �������� �� ������ �������
limitation=dlmread('InputData\limitation.csv',';'); %��������� ����������� �������� �� ������ �������

%% ������ ������������� �������� ������

%% 
% ����� ���� (������ ������)
%
% ������ � ������ ���� �������� � ���������� $S$ � ����������� �� ��� ���,
% ���� �� �������� �������� ����� �������� $S_k$, �.�.( $S$ < $S_k$ )
str=sprintf('��������� ���������� �������� ������: %d,��',s);
disp(str);
str=sprintf('�������� ���������� �������� ������: %d,��',sk);
disp(str);
str=sprintf('��������� �������� �������� ������: %d,��/�',v);
disp(str);
j=1;
i=0;
while s<sk-0.000001
    
    %%
    % ���������� ����������� �������� ��� ������� ���������� ������ $v_{lim}$
    vlim=findLimV(limitation,s);
    str = sprintf('����������� �������� � ����� %d,�� - %d,��/� \n',s,vlim(3));
    disp(str);
    %%
    % ���������� ������� ������� ���� � ������� �������� ����� � �������
    % ���������� $S$
    cur_prof=findS(profile,s);
    disp('�������������� �������� �������� ������� ����');
    str=sprintf('����� �������� ������� ����:                        %d',cur_prof(1));
    disp(str);
    str=sprintf('��������� ���������� �������� ������� ����:         %f,��',cur_prof(2));
    disp(str);
    str=sprintf('����� �������� �������� ������� ����:               %0+f',cur_prof(3));
    disp(str);
    str=sprintf('������ �������� �������� ������� ����:              %f,��',cur_prof(4));
    disp(str);
    str=sprintf('�������� ���������� �������� �������� ������� ����: %f,��\n',cur_prof(2)+cur_prof(4));
    disp(str);
    
    %%
    % ���� ������� �������������� ��������������� ������� �������� $v$
    cur_tx=findTX(traction,v);
    disp('�������������� ������� ������� ��������������');
    str=sprintf('����� ������� ������� �������������� %d',cur_tx(1));
    disp(str);
    str=sprintf('��������� �������� ��������������:   %f,��/�',cur_tx(2));
    disp(str);
    str=sprintf('�������� �������� ��������������     %f,��/�',cur_tx(3));
    disp(str);
    disp('������������ ������� ��������������');
    str=sprintf('�: %f; B: %f; C: %f;',cur_tx(4),cur_tx(5),cur_tx(6));
    disp(str);
    %%
    % �������� ������� �������������� � �������� �����
    cur_tx(4)=cur_tx(4)/(mp+ml);
    cur_tx(5)=cur_tx(5)/(mp+ml);
    cur_tx(6)=cur_tx(6)/(mp+ml);
    
    disp('������������ �������� ������� ��������������');
    str=sprintf('�: %f; B: %f; C: %f;\n',cur_tx(4),cur_tx(5),cur_tx(6));
    disp(str);
    
    %%
    % ���������� �������������� �������� ������ �� ������� ����
    if j==1
        sr=throtle_pnt(cur_tx,cur_prof,res,v,vlim(1,3),s,t,sk);
    else
        sr=cat(1,sr,throtle_pnt(cur_tx,cur_prof,res,v,vlim(1,3),s,t,sk));
    end
    
    %%
    % ������� ������ ��������� ������ ������� �����������
    j=size(sr,1);
    %%
    % ������������� ����� ������� ��������� ������
    v=sr(j,1);
    s=sr(j,2);
    t=sr(j,3);
    str=sprintf('������� ��������� �������� ������');
    disp(str);
    str=sprintf('�������� �������� ������: %f,��/�',v);
    disp(str);
    str=sprintf('������ ���������� ������: %f,��',s);
    disp(str);
    str=sprintf('����� ��������:           %f,�',t);
    disp(str);
    
    %%
    % ��������� ������, �� ��� ���, ���� �� ��������� ���������� $S_k$
  
end

%% ����� ������
%
sk=15;

cur_prof=findS(profile,s);
sr=cat(1,sr,runningdown(v,30.5,cur_prof,s,res,t));

%% ����������� ������������� ����������� �������
% ������� ������ �������� ������
plotRes(sr);

toc


%%

%�������� �� ��� ��, ���� s<sk, �.�. �� ��� ��� ���� �� �������� ��������
%����� ��������
% while s<=sk
%     vlim=findLimV(limitation,s);
%     if v<vlim(1,3) %���� �������� �� �������� ����������� ����� ����������� � ����
%         cur_tx=findTX(traction,v); %���� ������� �������������� ��������������� ������� ��������
%         % ���������� ��������� �������� � �������� �����
%         cur_tx(4)=cur_tx(4)/(mp+ml);
%         cur_tx(5)=cur_tx(5)/(mp+ml);
%         cur_tx(6)=cur_tx(6)/(mp+ml);
% 
%         cur_prof=findS(profile,s); %���� ������� ���� � ������� �������� ������� ����������
%         j=size(sr);
%         if j(1,1)==1
%             sr=throtle_pnt(cur_tx,cur_prof,res,v,vlim(1,3),s,t,sk);
%         else
%             sr=cat(1, sr,throtle_pnt(cur_tx,cur_prof,res,v,vlim(1,3),s,t,sk));
%         end
%         
%         j=size(sr);
%         v=sr(j(1,1),1);
%         s=sr(j(1,1),2);
%         t=sr(j(1,1),3);
%     end
% end
%-----------------
% ���� ��� �������� ������� ������� ���������� ������ �� ������
%-----------------
% while s<=sk
% cur_prof=findS(profile,s); %���� ������� ���� � ������� �������� ������� ����������
% j=size(sr);
% if j(1,1)==1
%     sr=runningdown(60,10,cur_prof,0,res,0);
% else
%     sr=cat(1, sr,runningdown(v,10,cur_prof,s,res,t));
% end
% j=size(sr);
% v=sr(j(1,1),1);
% s=sr(j(1,1),2);
% t=sr(j(1,1),3);
% end
% % � ����� �� ������ ������� ������� sr � ������������ ������� � csv ����
% % ��� ���������� ��������� � ���������� ��������, �.�. ������������
% dlmwrite('resultdata\result.csv',sr,';');




% %% �������������� ����� ���� -----------------------------------------
% cur_tx=findTX(traction,v); %���� ������� �������������� ��������������� ������� ��������
% % ���������� ��������� �������� � �������� �����
% cur_tx(4)=cur_tx(4)/(mp+ml);
% cur_tx(5)=cur_tx(5)/(mp+ml);
% cur_tx(6)=cur_tx(6)/(mp+ml);
% 
% cur_prof=findS(profile,s); %���� ������� ���� � ������� �������� ������� ����������
% sr=throtle_pnt(cur_tx,cur_prof,res,v,100,s,t);
% 
% cur_tx=findTX(traction,sr(11,1)); %���� ������� �������������� ��������������� ������� ��������
% % ���������� ��������� �������� � �������� �����
% cur_tx(4)=cur_tx(4)/(mp+ml);
% cur_tx(5)=cur_tx(5)/(mp+ml);
% cur_tx(6)=cur_tx(6)/(mp+ml);
% 
% cur_prof=findS(profile,sr(11,2));
% 
% sr=cat(1, sr,throtle_pnt(cur_tx,cur_prof,res,sr(11,1),100,sr(11,2),sr(11,3)));
% 
% 
% cur_tx=findTX(traction,sr(22,1)); %���� ������� �������������� ��������������� ������� ��������
% % ���������� ��������� �������� � �������� �����
% cur_tx(4)=cur_tx(4)/(mp+ml);
% cur_tx(5)=cur_tx(5)/(mp+ml);
% cur_tx(6)=cur_tx(6)/(mp+ml);
% 
% cur_prof=findS(profile,sr(22,2));
% 
% sr=cat(1, sr,throtle_pnt(cur_tx,cur_prof,res,sr(22,1),100,sr(22,2),sr(22,3)));